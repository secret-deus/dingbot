 # æŠ€æœ¯æ¶æ„ä¸é…ç½®æŒ‡å—

**æ–‡æ¡£ç‰ˆæœ¬**: v1.0  
**é€‚ç”¨èŒƒå›´**: å¼€å‘è€…ã€è¿ç»´äººå‘˜ã€ç³»ç»Ÿç®¡ç†å‘˜

---

## ğŸ—ï¸ ç³»ç»Ÿæ¶æ„è¯¦è§£

### æ•´ä½“æŠ€æœ¯æ¶æ„

```mermaid
graph TB
    A[ç”¨æˆ·ç•Œé¢] --> B[APIè·¯ç”±å±‚]
    B --> C[LLMå¤„ç†å™¨]
    C --> D[ğŸ” è„±æ•å±‚]
    D --> E[MCPå®¢æˆ·ç«¯]
    E --> F[ğŸ”“ æ¢å¤å±‚] 
    F --> G[MCPæœåŠ¡å™¨é›†ç¾¤]
    G --> H[å¤–éƒ¨ç³»ç»Ÿ]
    
    subgraph "å‰ç«¯å±‚"
        A
    end
    
    subgraph "åç«¯å±‚"
        B
        C
        D
        E
        F
    end
    
    subgraph "æœåŠ¡å±‚"
        G
        H
    end
```

### æ ¸å¿ƒæ¨¡å—è¯¦è§£

#### 1. é…ç½®ç®¡ç†ç³»ç»Ÿ

**ç»Ÿä¸€é…ç½®æ¶æ„**:
```
config/
â”œâ”€â”€ mcp_config.json      # MCPæœåŠ¡å™¨é…ç½®
â”œâ”€â”€ llm_providers.json   # LLMæä¾›å•†é…ç½®
â””â”€â”€ backups/            # é…ç½®å¤‡ä»½ç›®å½•
```

**é…ç½®ç®¡ç†å™¨å±‚æ¬¡**:
- `ConfigManager` - ç¯å¢ƒå˜é‡ + æ–‡ä»¶é…ç½®ç»Ÿä¸€ç®¡ç†
- `MCPConfigManager` - MCPä¸“ç”¨é…ç½®ç®¡ç†
- `LLMConfigManager` - LLMé…ç½®ç®¡ç† + çƒ­é‡è½½

**å…³é”®ç‰¹æ€§**:
- âœ… ç¯å¢ƒå˜é‡è‡ªåŠ¨è¿ç§»åˆ°æ–‡ä»¶é…ç½®
- âœ… å®æ—¶çƒ­é‡è½½ (watchdog)
- âœ… è‡ªåŠ¨å¤‡ä»½ä¸æ¢å¤
- âœ… å‘åå…¼å®¹æ€§ä¿è¯

#### 2. MCPåè®®é›†æˆ

**MCPå·¥å…·å‘ç°æµç¨‹**:
```python
# 1. è‡ªåŠ¨è¿æ¥MCPæœåŠ¡å™¨
client = EnhancedMCPClient()
await client.connect_to_server(server_config)

# 2. å·¥å…·å‘ç°ä¸æ³¨å†Œ
tools = await client.list_tools()
auto_sync_tools_config(tools)

# 3. æ™ºèƒ½å·¥å…·è°ƒç”¨
result = await client.call_tool(tool_name, parameters)
```

**æ”¯æŒçš„MCPæœåŠ¡å™¨**:
- **Kubernetes MCP**: 20+ä¸ªK8sç®¡ç†å·¥å…·
- **SSH Jumpserver MCP**: è¿œç¨‹æ‰§è¡Œã€èµ„æºç®¡ç†å·¥å…·

#### 3. æ•°æ®å®‰å…¨ç³»ç»Ÿ

**è„±æ•å¤„ç†æµç¨‹**:
```python
# è„±æ•å±‚ (DataMasker)
masked_data = masker.mask_sensitive_data(original_data)
store_mapping(original_data, masked_data)

# æ¢å¤å±‚ (åŒé˜¶æ®µæ¢å¤)
# é˜¶æ®µ1: æµå¼æ¢å¤
stream_response = restore_llm_response(stream_chunk)
# é˜¶æ®µ2: å®Œæ•´æ¢å¤  
final_response = restore_llm_response(full_response)
```

**æ”¯æŒçš„è„±æ•ç±»å‹**:
- **IPåœ°å€**: `192.168.1.100` â†’ `10.0.abc1.100` 
- **ä¸»æœºå**: `prod-server-01` â†’ `host-def2a-01`
- **äººå**: `å¼ ä¸‰` â†’ `ç”¨æˆ·A`

---

## âš™ï¸ é…ç½®ç®¡ç†æŒ‡å—

### 1. LLMé…ç½®ç®¡ç†

**é…ç½®æ–‡ä»¶ç»“æ„** (`config/llm_providers.json`):
```json
{
  "providers": {
    "openai": {
      "api_key": "sk-xxx",
      "base_url": "https://api.openai.com/v1",
      "model": "gpt-4",
      "enabled": true
    },
    "azure": {
      "api_key": "xxx",
      "azure_endpoint": "https://xxx.openai.azure.com/",
      "api_version": "2024-02-15-preview",
      "model": "gpt-4",
      "enabled": false
    }
  },
  "global_defaults": {
    "temperature": 0.7,
    "max_tokens": 4000,
    "timeout": 30
  }
}
```

**é…ç½®APIç«¯ç‚¹**:
- `GET /api/v2/llm/config/current` - è·å–å½“å‰é…ç½®
- `POST /api/v2/llm/config/update` - æ›´æ–°é…ç½®
- `POST /api/v2/llm/config/providers` - æ·»åŠ /æ›´æ–°æä¾›å•†
- `GET /api/v2/llm/config/file-watcher/status` - çƒ­é‡è½½çŠ¶æ€

### 2. MCPé…ç½®ç®¡ç†

**é…ç½®æ–‡ä»¶ç»“æ„** (`config/mcp_config.json`):
```json
{
  "servers": {
    "k8s-server": {
      "enabled": true,
      "connection": {
        "type": "http",
        "url": "http://localhost:8001/mcp"
      }
    }
  },
  "tools": {
    "k8s-get-pods": {
      "enabled": true,
      "server_name": "k8s-server",
      "category": "kubernetes"
    }
  }
}
```

**é…ç½®APIç«¯ç‚¹**:
- `GET /api/v2/mcp/config` - è·å–å®Œæ•´é…ç½®
- `POST /api/v2/mcp/config` - æ›´æ–°é…ç½®
- `POST /api/v2/mcp/config/import` - å¯¼å…¥é…ç½®
- `GET /api/v2/mcp/config/export` - å¯¼å‡ºé…ç½®

### 3. ç¯å¢ƒå˜é‡è¿ç§»

**è‡ªåŠ¨è¿ç§»è„šæœ¬**:
```bash
# æ‰‹åŠ¨è¿ç§»
poetry run python scripts/migrate_llm_config.py migrate

# æŸ¥çœ‹è¿ç§»çŠ¶æ€
poetry run python scripts/migrate_llm_config.py status

# å›æ»šåˆ°ç¯å¢ƒå˜é‡
poetry run python scripts/migrate_llm_config.py rollback
```

---

## ğŸ”§ å¼€å‘ç¯å¢ƒé…ç½®

### 1. ç¯å¢ƒå‡†å¤‡

**Pythonç¯å¢ƒç®¡ç†**:
- æœ¬é¡¹ç›®ä¸¥æ ¼ä½¿ç”¨ **Poetry** è¿›è¡ŒPythonä¾èµ–ç®¡ç†
- æ‰€æœ‰Pythonç›¸å…³æ“ä½œå¿…é¡»é€šè¿‡Poetryæ‰§è¡Œ

**ä¾èµ–å®‰è£…**:
```bash
# Pythonä¾èµ– (Poetry)
poetry install

# Node.jsä¾èµ–
cd frontend && npm install
```

**ç¯å¢ƒå˜é‡é…ç½®**:
```bash
# å¤åˆ¶ç¯å¢ƒå˜é‡æ¨¡æ¿
cp backend/config.env.example backend/config.env
cp k8s-mcp/config.env.example k8s-mcp/config.env
```

### 1.1. Poetryé¡¹ç›®ç®¡ç†è§„èŒƒ

> ğŸš¨ **é‡è¦æé†’**: æœ¬é¡¹ç›®çš„æ‰€æœ‰Pythonæ“ä½œå¿…é¡»é€šè¿‡Poetryç®¡ç†ï¼Œç¦æ­¢ç›´æ¥ä½¿ç”¨pipæˆ–ç³»ç»ŸPython

#### åŸºæœ¬è§„åˆ™

**âœ… æ­£ç¡®ä½¿ç”¨æ–¹å¼**:
```bash
# å®‰è£…ä¾èµ–
poetry install

# è¿è¡ŒPythonè„šæœ¬
poetry run python script.py

# è¿è¡Œåç«¯æœåŠ¡
poetry run python backend/main.py

# æ‰§è¡Œæµ‹è¯•
poetry run python -m pytest

# å¯åŠ¨MCPæœåŠ¡
poetry run python k8s-mcp/start_k8s_mcp_http_server.py

# æ·»åŠ æ–°ä¾èµ–
poetry add package_name

# æ·»åŠ å¼€å‘ä¾èµ–
poetry add --group dev package_name
```

**âŒ ç¦æ­¢çš„æ“ä½œ**:
```bash
# ç›´æ¥ä½¿ç”¨pip (ä¼šç ´åä¾èµ–ç®¡ç†)
pip install package_name

# ç›´æ¥ä½¿ç”¨ç³»ç»ŸPython
python script.py

# åœ¨Poetryç¯å¢ƒå¤–è¿è¡Œ
./script.py
```

#### å¤šæ¨¡å—é¡¹ç›®ç»“æ„

æœ¬é¡¹ç›®åŒ…å«å¤šä¸ªç‹¬ç«‹çš„Pythonæ¨¡å—ï¼Œæ¯ä¸ªéƒ½æœ‰è‡ªå·±çš„`pyproject.toml`:

```
ding-robot/
â”œâ”€â”€ pyproject.toml          # ä¸»é¡¹ç›®é…ç½®
â”œâ”€â”€ backend/                # åç«¯APIæ¨¡å—
â”œâ”€â”€ k8s-mcp/               # K8s MCPæœåŠ¡å™¨
â”‚   â”œâ”€â”€ pyproject.toml     # ç‹¬ç«‹çš„Poetryé…ç½®
â”‚   â””â”€â”€ poetry.lock        # ç‹¬ç«‹çš„é”æ–‡ä»¶
â””â”€â”€ ssh-jumpserver-mcp/    # SSHè·³æ¿æœºMCPæœåŠ¡å™¨
```

#### ä¾èµ–ç®¡ç†æœ€ä½³å®è·µ

1. **ç¯å¢ƒéš”ç¦»**: æ¯ä¸ªæ¨¡å—ä½¿ç”¨ç‹¬ç«‹çš„è™šæ‹Ÿç¯å¢ƒ
2. **ç‰ˆæœ¬é”å®š**: ä½¿ç”¨`poetry.lock`ç¡®ä¿ä¸€è‡´æ€§
3. **åˆ†ç»„ç®¡ç†**: åŒºåˆ†ç”Ÿäº§å’Œå¼€å‘ä¾èµ–
4. **å®šæœŸæ›´æ–°**: ä½¿ç”¨`poetry update`æ›´æ–°ä¾èµ–

#### å¸¸è§é—®é¢˜è§£å†³

**è™šæ‹Ÿç¯å¢ƒé—®é¢˜**:
```bash
# æŸ¥çœ‹è™šæ‹Ÿç¯å¢ƒä¿¡æ¯
poetry env info

# é‡å»ºè™šæ‹Ÿç¯å¢ƒ
poetry env remove python
poetry install
```

**ä¾èµ–å†²çªè§£å†³**:
```bash
# æŸ¥çœ‹ä¾èµ–æ ‘
poetry show --tree

# æ›´æ–°ç‰¹å®šåŒ…
poetry update package_name
```

### 2. å¼€å‘å¯åŠ¨

**å¯åŠ¨é¡ºåº**:
```bash
# 1. å¯åŠ¨MCPæœåŠ¡å™¨
poetry run python k8s-mcp/start_k8s_mcp_http_server.py
poetry run python ssh-jumpserver-mcp/start_mcp_server.py

# 2. å¯åŠ¨åç«¯API
poetry run python backend/main.py

# 3. å¯åŠ¨å‰ç«¯å¼€å‘æœåŠ¡å™¨
cd frontend && npm run dev
```

### 3. æµ‹è¯•éªŒè¯

**å•å…ƒæµ‹è¯•**:
```bash
# åç«¯æµ‹è¯•
poetry run python -m pytest backend/tests/

# é…ç½®ç®¡ç†æµ‹è¯•
poetry run python -m pytest backend/tests/test_config_manager.py -v
```

**APIæµ‹è¯•**:
```bash
# å¥åº·æ£€æŸ¥
curl http://localhost:8000/health

# MCPé…ç½®æµ‹è¯•
curl http://localhost:8000/api/v2/mcp/config

# LLMé…ç½®æµ‹è¯•  
curl http://localhost:8000/api/v2/llm/config/current
```

---

## ğŸš€ ç”Ÿäº§éƒ¨ç½²

### 1. Dockeréƒ¨ç½²

**Dockerfileç¤ºä¾‹**:
```dockerfile
FROM python:3.11-slim
WORKDIR /app
COPY pyproject.toml poetry.lock ./
RUN pip install poetry && poetry install --no-dev
COPY . .
EXPOSE 8000
CMD ["poetry", "run", "python", "backend/main.py"]
```

### 2. Kuberneteséƒ¨ç½²

**åŸºæœ¬é…ç½®**:
```yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: ding-robot-backend
spec:
  replicas: 3
  selector:
    matchLabels:
      app: ding-robot-backend
  template:
    spec:
      containers:
      - name: backend
        image: ding-robot:latest
        ports:
        - containerPort: 8000
        env:
        - name: ENV
          value: "production"
```

### 3. ç›‘æ§ä¸æ—¥å¿—

**æ—¥å¿—é…ç½®**:
- **åº”ç”¨æ—¥å¿—**: `logs/app.log`
- **è®¿é—®æ—¥å¿—**: `logs/access.log` 
- **é”™è¯¯æ—¥å¿—**: `logs/error.log`

**ç›‘æ§æŒ‡æ ‡**:
- APIå“åº”æ—¶é—´
- MCPå·¥å…·è°ƒç”¨æˆåŠŸç‡
- é…ç½®çƒ­é‡è½½çŠ¶æ€
- è„±æ•æ¢å¤å‡†ç¡®ç‡

---

## ğŸ” æ•…éšœæ’é™¤

### å¸¸è§é—®é¢˜

1. **é…ç½®æ–‡ä»¶ä¸å­˜åœ¨**
   ```bash
   # è§£å†³æ–¹æ¡ˆ: è‡ªåŠ¨åˆ›å»ºé»˜è®¤é…ç½®
   poetry run python scripts/migrate_llm_config.py migrate
   ```

2. **MCPæœåŠ¡å™¨è¿æ¥å¤±è´¥**
   ```bash
   # æ£€æŸ¥æœåŠ¡å™¨çŠ¶æ€
   curl http://localhost:8001/health
   ```

3. **çƒ­é‡è½½ä¸å·¥ä½œ**
   ```bash
   # æ£€æŸ¥æ–‡ä»¶ç›‘æ§çŠ¶æ€
   curl http://localhost:8000/api/v2/llm/config/file-watcher/status
   ```

### è°ƒè¯•æ¨¡å¼

**å¯ç”¨è°ƒè¯•æ—¥å¿—**:
```python
# backend/main.py
import logging
logging.basicConfig(level=logging.DEBUG)
```

**é…ç½®è°ƒè¯•**:
```json
{
  "debug_logging": true,
  "log_masked_data": true
}
```

---

## ğŸ“š ç›¸å…³æ–‡æ¡£

- [é¡¹ç›®æ€»è§ˆä¸æœ€æ–°çŠ¶æ€](./é¡¹ç›®æ€»è§ˆä¸æœ€æ–°çŠ¶æ€.md)
- [APIæ–‡æ¡£](./api-documentation.md)
- [LLMé…ç½®è¿ç§»æŒ‡å—](./llm-config-migration-guide.md)

---

*æœ¬æ–‡æ¡£éšç€ç³»ç»Ÿæ¼”è¿›æŒç»­æ›´æ–°*