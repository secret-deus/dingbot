# MCP工具调用结果优化指南

## 概述

为了解决MCP工具调用结果过大导致LLM上下文溢出的问题，我们实现了一套智能的结果处理和上下文管理系统。

## 核心功能

### 1. 智能结果大小检测

系统会自动检测MCP工具调用结果的大小：
- **字符限制**: 50,000字符 (约50KB)
- **行数限制**: 1,000行
- **摘要目标**: 8,000字符

### 2. 智能关键信息提炼

当结果过大时，系统会根据工具类型采用不同的提炼策略：

#### Kubernetes工具 (`k8s_*`) - 增强版
- **🎯 目标资源优先**: 自动识别用户查询的特定资源名称，优先保留相关信息
- **智能资源识别**: 支持多种模式匹配：
  - 带连字符的资源名称（如 `med-marketing`）
  - 引号中的资源名称
  - 资源类型后的名称（如 `deployment nginx-app`）
  - 命名空间+资源组合（如 `test namespace下的med-marketing`）
- **分层信息保留**:
  1. 用户查询的目标资源（全部保留）
  2. 统计摘要信息
  3. 表格头部
  4. 错误和异常状态（优先）
  5. 其他重要信息

#### 日志工具 (`*log*`)
- 优先保留错误和警告日志
- 按日志级别分类处理
- 限制普通信息日志的数量

#### 通用工具
- 保留开头和结尾的重要信息
- 智能省略中间的冗余内容

### 3. 分页建议系统

当结果被优化时，系统会自动生成针对性的分页建议：

```
💡 建议使用分页参数：--limit=20 --namespace=specific-namespace
💡 或使用标签选择器：--selector=app=your-app
💡 建议限制日志行数：--tail=100 --since=1h
💡 如需完整数据，请使用更具体的查询条件
```

### 4. 上下文管理优化

系统会智能管理对话上下文：
- **最大上下文**: 100,000 tokens（估算）
- **最大历史消息**: 20条
- 保留系统消息和最近的完整对话循环
- 自动添加上下文摘要信息

## 配置参数

在 `backend/src/llm/processor.py` 中的配置：

```python
# 结果大小管理配置
MAX_RESULT_SIZE = 50000  # 50KB 字符限制
MAX_RESULT_LINES = 1000  # 最大行数限制
SUMMARY_TARGET_SIZE = 8000  # 摘要目标大小

# 上下文管理配置
MAX_CONTEXT_TOKENS = 100000  # 最大上下文token数（估算）
MAX_HISTORY_MESSAGES = 20  # 最大历史消息数
```

## 使用示例

### 优化前的问题
```
用户: 获取所有Pod信息
系统: [返回10000行Pod信息，导致上下文溢出]
LLM: [无法响应或响应不完整]
```

### 优化后的效果
```
用户: 查看test空间下med-marketing deployment的状态
系统: [智能提炼关键信息]
🎯 检测到目标资源: ['med-marketing']
- 优先保留med-marketing相关信息
- 显示deployment状态详情
- 提供优化建议

[已智能提炼关键信息，原始数据 1000 行，显示 45 行，过滤 955 行]
[✅ 已优先保留查询的目标资源: med-marketing]

💡 建议使用分页参数：--limit=20 --namespace=specific-namespace

LLM: 我找到了test命名空间下的med-marketing deployment，状态如下：
- 名称: med-marketing
- 命名空间: test  
- 副本数: 1/1 (Ready)
- 运行时间: 173天
- 状态: 正常运行
```

## 日志监控

系统会记录优化过程：

```
INFO: 工具 k8s_get_deployments 结果过大，正在提炼关键信息...
INFO: 🎯 检测到目标资源: ['med-marketing']
INFO: 关键信息提炼完成，大小从 150000 减少到 8500
INFO: 上下文过大 (120000 tokens, 25 messages)，正在优化...
INFO: 上下文优化完成: 25 -> 15 messages, 120000 -> 85000 tokens
```

## 最佳实践

### 1. 使用具体的查询条件
- 指定namespace而不是查询所有
- 使用标签选择器过滤资源
- 限制时间范围和日志行数

### 2. 分批处理大量数据
- 使用分页参数
- 按类型或状态分别查询
- 优先查询异常资源

### 3. 监控系统性能
- 关注日志中的优化提示
- 根据建议调整查询参数
- 定期检查上下文使用情况

## 典型问题解决案例

### 问题：查询特定资源时返回"未找到"

**症状**: 用户查询特定资源（如`med-marketing deployment`），但LLM回复说未找到，实际上资源是存在的。

**原因**: MCP工具返回了整个集群的资源列表，结果过大被截断，用户查询的特定资源在被截断的部分中。

**解决方案**: 
1. **智能资源识别**: 系统现在会自动识别用户查询的目标资源名称
2. **优先保留**: 目标资源信息会被优先保留，不会被过滤掉
3. **调试日志**: 查看日志中的`🎯 检测到目标资源`信息

**示例**:
```
用户输入: "查看test空间下med-marketing deployment的状态"
系统识别: ['med-marketing'] 
结果: 优先保留med-marketing相关的所有信息
```

## 故障排除

### 如果仍然遇到上下文问题
1. 检查是否使用了过于宽泛的查询
2. 考虑进一步减小 `MAX_RESULT_SIZE` 配置
3. 增加更具体的过滤条件
4. 使用多次小查询替代单次大查询

### 如果关键信息丢失
1. 检查提炼策略是否适合您的用例
2. 考虑调整关键词列表
3. 使用更具体的工具和参数
4. 分步骤获取详细信息

## 更新日志

- **2024-01-XX**: 实现智能结果大小检测和关键信息提炼
- **2024-01-XX**: 添加分页建议系统
- **2024-01-XX**: 实现上下文管理优化
- **2024-01-XX**: 完善日志监控和错误处理
